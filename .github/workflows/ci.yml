name: CI ðŸ“º

on:
  push:
    branches:
      - main
      - setup-ci
  pull_request: {}

jobs:
  check:
    name: Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install rust deps
        run: sudo apt-get install pkg-config
#       run: sudo apt-get install g++ pkg-config libx11-dev libasound2-dev libudev-dev lld

      - name: Install rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable
          override: true

      - name: Cache
        uses: swatinem/rust-cache@v2
        with:
          shared-key: ${{ runner.os }}-base

      - name: Cargo check
        uses: actions-rs/cargo@v1
        with:
          command: check
          args: --manifest-path ./src-tauri/Cargo.toml

  test:
    name: Test Suite
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install rust deps
        run: sudo apt-get install pkg-config

      - name: Install rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable
          override: true

      - name: Cache
        uses: swatinem/rust-cache@v2
        with:
          shared-key: ${{ runner.os }}-test

      - name: Cargo test
        uses: actions-rs/cargo@v1
        with:
          command: test
          args: --manifest-path ./src-tauri/Cargo.toml

  yarnTest:
    name: Test Suite (yarn)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install rust deps
        run: sudo apt-get install pkg-config

      - name: Rust Cache
        uses: swatinem/rust-cache@v2
        with:
          shared-key: ${{ runner.os }}-test

      - name: Yarn cache
        uses: actions/cache@v2
        with:
          path: |
            ~/.cache/yarn
            **/node_modules
          key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-yarn-

      - name: Install rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable
          override: true

      - uses: borales/actions-yarn@v3.0.0
        with:
          cmd: install

      - uses: borales/actions-yarn@v3.0.0
        with:
          cmd: step-ci-test

  fmt:
    name: Rustfmt
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install rust deps
        run: sudo apt-get install pkg-config

      - name: Install rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable
          override: true

      - name: Install rustfmt
        run: rustup component add rustfmt

      - name: Cargo fmt
        uses: actions-rs/cargo@v1
        with:
          command: fmt
          args: --manifest-path ./src-tauri/Cargo.toml --all -- --check

  clippy:
    name: Clippy
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install rust deps
        run: sudo apt-get install pkg-config

      - name: Install rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable
          override: true

      - name: Install clippy
        run: rustup component add clippy

      - name: Cache
        uses: swatinem/rust-cache@v2
        with:
          shared-key: ${{ runner.os }}-base

      - name: Cargo clippy
        uses: actions-rs/cargo@v1
        with:
          command: clippy
          args: --manifest-path ./src-tauri/Cargo.toml -- -D warnings
